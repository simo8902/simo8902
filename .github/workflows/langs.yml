name: Langs
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SVG
        run: |
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/users/YOUR_USERNAME/repos?per_page=100 > repos.json
          python3 << 'EOF'
import requests, os, json
token = os.environ["GITHUB_TOKEN"]
headers = {"Authorization": f"Bearer {token}"}
repos = requests.get("https://api.github.com/users/YOUR_USERNAME/repos?per_page=100", headers=headers).json()
langs = {}
for r in repos:
    if r["fork"]: continue
    l = requests.get(r["languages_url"], headers=headers).json()
    for k,v in l.items():
        langs[k] = langs.get(k,0)+v
total = sum(langs.values())
svg = "<svg xmlns='http://www.w3.org/2000/svg' width='600' height='200'>"
y=20
for k,v in sorted(langs.items(), key=lambda x:-x[1]):
    pct = round(v/total*100,2)
    svg+=f"<text x='10' y='{y}' font-size='16'>{k}: {pct}%</text>"
    y+=20
svg+="</svg>"
open("langs.svg","w").write(svg)
EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Commit
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add langs.svg
          git commit -m "update langs" || exit 0
          git push